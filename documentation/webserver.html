<!DOCTYPE html>

<html>
<head>
  <title>webserver.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>webserver.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="router.html">
                    router.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="webserver.html">
                    webserver.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-pi">
'use strict'</span>;

(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(exports)</span> {</span>

  <span class="hljs-keyword">var</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>)
  <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)
  <span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)

  <span class="hljs-keyword">var</span> dirlisting = <span class="hljs-built_in">require</span>(<span class="hljs-string">"phantomizer-html-dirlisting"</span>).html_dirlisting;

  <span class="hljs-keyword">var</span> http_utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./http_utils"</span>).http_utils;
  <span class="hljs-keyword">var</span> file_utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./file_utils"</span>).file_utils;
  <span class="hljs-keyword">var</span> phantomizer_helper = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./phantomizer_helper"</span>).phantomizer_helper;
  <span class="hljs-keyword">var</span> delivery_queue = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./delivery_queue"</span>).delivery_queue;

  <span class="hljs-keyword">var</span> webserver = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(router,optimizer,meta_manager,working_dir, user_config,grunt)</span>{</span></pre></div>
        
      
        
        <p>requirejs options</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> requirejs_src = user_config.scripts.requirejs.src;
    <span class="hljs-keyword">var</span> requirejs_baseUrl = user_config.scripts.requirejs.baseUrl;
    <span class="hljs-keyword">var</span> requirejs_paths = user_config.scripts.requirejs.paths;</pre></div>
        
      
        
        <p>Server side Bandwidth and congestion manager</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> min_congestion = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> max_congestion = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> cur_bdw = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> deliverer = <span class="hljs-keyword">new</span> delivery_queue();</pre></div>
        
      
        
        <p>HTML Document injection and manipulation</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> is_phantom = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> is_in_build_process = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> dashboard_enabled = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> build_enabled = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> assets_injection_enabled = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> globals_injected = <span class="hljs-literal">null</span>;</pre></div>
        
      
        
        <p>logs the query that was identified as a file</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> log_query = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> query_logged = [];</pre></div>
        
      
        
        <p>new connect web server</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> connect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect'</span>);
    <span class="hljs-keyword">var</span> app = connect();
    app.use(connect.query());
    app.use(connect.urlencoded());</pre></div>
        
      
        
        <p>active requests logging</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span>( user_config.log ){
      app.use(connect.logger(<span class="hljs-string">'dev'</span>));
    }</pre></div>
        
      
        
        <h2 id="built-in-routes">Built-in routes</h2>

        
      
        
        
        
      
        
        <p><strong>JSON Pong responder</strong></p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * req is an object representing the response to send
     * {
     *  response_code:xx
     *  response_body:xx
     * }
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pong_response</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
      };
      res.writeHead(req.body.response_code || <span class="hljs-number">404</span>, headers);
      res.end(req.body.response_body);
    }</pre></div>
        
      
        
        <p>use this route to respond what you send
useful for ajax mocking purpose</p>

        
          <div class='highlight'><pre>    app.use(<span class="hljs-string">"/pong"</span>,pong_response);</pre></div>
        
      
        
        <p><strong>Latency management</strong></p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * Returns the current
     * maximum latency
     * configuration : [0-9]+ms
     *
     * route is in the form
     *  /stryke_get_max_congestion
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">max_latency_getter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      res.writeHead(<span class="hljs-number">200</span>, headers);
      res.end(max_congestion+<span class="hljs-string">"ms"</span>);
    }
    app.use(<span class="hljs-string">"/stryke_get_max_congestion"</span>, max_latency_getter);

    <span class="hljs-comment">/**
     * Sets the maximum latency
     * configuration
     *
     * route is in the form
     *  /stryke_max_congestion/[0-9]+(ms|s)
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">max_latency_setter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );
      <span class="hljs-keyword">if</span>( request_path.match(<span class="hljs-regexp">/^\/stryke_max_congestion\/(.*)[ms|s]$/</span>) ){
        <span class="hljs-keyword">var</span> n = request_path.match(<span class="hljs-regexp">/^\/stryke_max_congestion\/(.*)[ms|s]$/</span>)[<span class="hljs-number">1</span>]
        max_congestion = <span class="hljs-built_in">parseInt</span>(n);

        <span class="hljs-keyword">var</span> headers = {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
        };
        res.writeHead(<span class="hljs-number">200</span>, headers);
        res.end(<span class="hljs-string">"ok"</span>);
      }
    }
    app.use(<span class="hljs-string">"/stryke_max_congestion"</span>, max_latency_setter);

    <span class="hljs-comment">/**
     * Returns the current
     * minimum latency
     * configuration : [0-9]+ms
     *
     * route is in the form
     *  /get_stryke_min_congestion
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">min_latency_getter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      res.writeHead(<span class="hljs-number">200</span>, headers);
      res.end(min_congestion+<span class="hljs-string">"ms"</span>);
    }
    app.use(<span class="hljs-string">"/get_stryke_min_congestion"</span>, min_latency_getter);


    <span class="hljs-comment">/**
     * Sets the minimum latency
     * configuration
     *
     * route is in the form
     *  /stryke_min_congestion/[0-9]+(ms|s)
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">min_latency_setter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );
      <span class="hljs-keyword">if</span>( request_path.match(<span class="hljs-regexp">/^\/stryke_min_congestion\/(.*)[ms|s]$/</span>) ){
        <span class="hljs-keyword">var</span> n = request_path.match(<span class="hljs-regexp">/^\/stryke_min_congestion\/(.*)[ms|s]$/</span>)[<span class="hljs-number">1</span>];
        min_congestion = <span class="hljs-built_in">parseInt</span>(n);

        cur_bdw = <span class="hljs-built_in">parseInt</span>(n);
        <span class="hljs-keyword">var</span> headers = {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
        };
        res.writeHead(<span class="hljs-number">200</span>, headers);
        res.end(<span class="hljs-string">"ok"</span>);
      }
    }
    app.use(<span class="hljs-string">"/stryke_min_congestion"</span>, min_latency_setter);</pre></div>
        
      
        
        <p><strong>Bandwidth management</strong></p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * Returns the current
     * bandwidth
     * configuration : [0-9]+k
     *
     * route is in the form
     *  /stryke_get_bdw
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bdw_getter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      res.writeHead(<span class="hljs-number">200</span>, headers);
      res.end(cur_bdw+<span class="hljs-string">"k"</span>);
    }
    app.use(<span class="hljs-string">"/stryke_get_bdw"</span>, bdw_getter);

    <span class="hljs-comment">/**
     * Sets the minimum latency
     * configuration
     *
     * route is in the form
     *  /stryke_bdw/[0-9]+(b|kb|mb)
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bdw_setter</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );
      <span class="hljs-keyword">if</span>( request_path.match(<span class="hljs-regexp">/^\/stryke_bdw\/(.*)[b|kb,mb]$/</span>) ){
        <span class="hljs-keyword">var</span> n = request_path.match(<span class="hljs-regexp">/^\/stryke_bdw\/(.*)[b|kb,mb]/</span>)[<span class="hljs-number">1</span>];

        cur_bdw = <span class="hljs-built_in">parseInt</span>(n);
        deliverer.set_bdw( n );
        <span class="hljs-keyword">var</span> headers = {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
        };
        res.writeHead(<span class="hljs-number">200</span>, headers);
        res.end(<span class="hljs-string">"ok"</span>);
      }
    }
    app.use(<span class="hljs-string">"/stryke_bdw"</span>, bdw_setter);</pre></div>
        
      
        
        <p><strong>Cache management</strong>
ensure the build cache is empty</p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * ensure the build cache is empty
     *
     * route is in the form
     *  /stryke_clean
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clean_cache</span><span class="hljs-params">(req, res, next)</span>{</span>

      <span class="hljs-keyword">var</span> grunt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'grunt'</span>);

      file_utils.deleteFolderRecursive(user_config.out_dir);
      grunt.file.mkdir(user_config.out_dir);

      file_utils.deleteFolderRecursive(user_config.meta_dir);
      grunt.file.mkdir(user_config.meta_dir);

      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      res.writeHead(<span class="hljs-number">200</span>, headers);
      res.end(<span class="hljs-string">"ok"</span>);
    }
    app.use(<span class="hljs-string">"/stryke_clean"</span>, clean_cache);</pre></div>
        
      
        
        <p><strong>Documentation management</strong></p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * Invoke grunt task for documentation
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invoke_documentation_tasks</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      grunt.config.init(user_config);
      grunt.tasks([<span class="hljs-string">"phantomizer-docco"</span>,<span class="hljs-string">"phantomizer-styledocco"</span>], {}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        res.writeHead(<span class="hljs-number">200</span>, headers);
        res.end(<span class="hljs-string">"ok"</span>);
      });
    }
    app.use(<span class="hljs-string">"/sryke_generate_documentation"</span>, invoke_documentation_tasks);

    <span class="hljs-comment">/**
     * lists a documentation directory
     * in an html fashion
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">list_documentation_dir</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );
      <span class="hljs-keyword">if</span>( request_path.match(<span class="hljs-regexp">/^\/stryke_doc(.*)/</span>) ){
        request_path = request_path.match(<span class="hljs-regexp">/^\/stryke_doc(.*)/</span>)[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> path = user_config.documentation_dir+request_path;

        <span class="hljs-keyword">if</span>( grunt.file.isDir(path) ){
          <span class="hljs-keyword">var</span> items = http_utils.merged_dirs([user_config.documentation_dir], request_path);
          <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> items) {
            items[i].path = <span class="hljs-string">"/stryke_doc"</span>+items[i].path;
          }
          dirlisting.generate_directory_listing(items, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, html)</span>{</span>
            res.end(html);
          });
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(<span class="hljs-string">"/stryke_doc"</span>, list_documentation_dir);

    <span class="hljs-comment">/**
     * reads a documentation file
     * in an html fashion
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_documentation_file</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );

      <span class="hljs-keyword">if</span>( request_path.match(<span class="hljs-regexp">/^\/stryke_doc(.*)/</span>) ){
        request_path = request_path.match(<span class="hljs-regexp">/^\/stryke_doc(.*)/</span>)[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> path = user_config.documentation_dir+request_path;

        <span class="hljs-keyword">if</span>( grunt.file.isFile(path) ){
          <span class="hljs-keyword">var</span> headers = {
            <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
          };
          res.writeHead(<span class="hljs-number">200</span>, headers);
          res.end( fs.readFileSync(path));
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(<span class="hljs-string">"/stryke_doc"</span>, read_documentation_file);</pre></div>
        
      
        
        <p><strong>Base64 support</strong></p>

        
          <div class='highlight'><pre>    <span class="hljs-comment">/**
     * Returns base64 encoded version
     * of a file
     *
     * route is in the form
     *  /stryke_b64/some/file.ext
     *
     * @param req
     * @param res
     * @param next
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_b64_file</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );

      <span class="hljs-keyword">if</span>(request_path.match(<span class="hljs-regexp">/^\/stryke_b64/</span>) ){
        request_path = request_path.replace( <span class="hljs-regexp">/^\/stryke_b64/</span>, <span class="hljs-string">""</span> );

        <span class="hljs-keyword">var</span> file = file_utils.find_file(user_config.web_paths, request_path);

        <span class="hljs-keyword">if</span>( file ){
          <span class="hljs-keyword">var</span> buf = fs.readFileSync(file).toString(<span class="hljs-string">'base64'</span>);
          <span class="hljs-keyword">var</span> headers = {
            <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(file)
          };
          res.writeHead(<span class="hljs-number">200</span>, headers);
          res.end(<span class="hljs-string">"data:"</span>+headers[<span class="hljs-string">'Content-Type'</span>]+<span class="hljs-string">";base64,"</span>+ buf );
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(<span class="hljs-string">"/stryke_b64"</span>, read_b64_file);</pre></div>
        
      
        
        <p><strong>Phantomizer build support</strong></p>

        
      
        
        <p>render optimized html route</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">optimize_routed_url</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );</pre></div>
        
      
        
        <p>only if build is enabled and requested in GET params</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span>( build_enabled &amp;&amp; is_build_required(req) ){</pre></div>
        
      
        
        <p>catch for html route directory</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">var</span> route = router.match(request_path);
        <span class="hljs-keyword">if</span>( route != <span class="hljs-literal">false</span> ){
          grunt.verbose.ok(<span class="hljs-string">"found routable url"</span>, request_path);

          <span class="hljs-keyword">var</span> headers = {
            <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
          };

          <span class="hljs-keyword">var</span> respond = write_handler(max_congestion,min_congestion,deliverer);</pre></div>
        
      
        
        <p>profile to use for optimization</p>

        
          <div class='highlight'><pre>          <span class="hljs-keyword">var</span> tgt_build_profile = buidl_profile(req);</pre></div>
        
      
        
        <p>check cache status</p>

        
          <div class='highlight'><pre>          <span class="hljs-keyword">var</span> is_already_build = optimizer.is_built(tgt_build_profile, request_path);
          <span class="hljs-keyword">var</span> is_fresh_build = optimizer.is_build_fresh(tgt_build_profile, request_path);

          <span class="hljs-keyword">if</span>( is_already_build &amp;&amp; is_fresh_build ){</pre></div>
        
      
        
        <p>read built file</p>

        
          <div class='highlight'><pre>            grunt.log.ok(<span class="hljs-string">"is_built and is_fresh"</span>,request_path);
            optimizer.read_fresh_build(tgt_build_profile, request_path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, buf)</span>{</span>
              buf = inject_extras(req, buf, is_phantom);
              <span class="hljs-keyword">if</span>( log_query ) query_logged[request_path] = path;
              respond(<span class="hljs-number">200</span>, headers, buf, res);
            })
          }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(is_already_build){</pre></div>
        
      
        
        <p>regen the build</p>

        
          <div class='highlight'><pre>            grunt.verbose.ok(<span class="hljs-string">"is_built and is_not_fresh"</span>,request_path);
            optimizer.regen_build(tgt_build_profile, request_path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, buf)</span>{</span>
              buf = inject_extras(req, buf, is_phantom);
              <span class="hljs-keyword">if</span>( log_query ) query_logged[request_path] = path;
              respond(<span class="hljs-number">200</span>, headers, buf, res);
            });
          }<span class="hljs-keyword">else</span>{</pre></div>
        
      
        
        <p>make the build</p>

        
          <div class='highlight'><pre>            grunt.verbose.ok(<span class="hljs-string">"is_not_built and is_not_fresh"</span>,request_path);
            optimizer.do_build(tgt_build_profile, request_path, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, buf)</span>{</span>
              buf = inject_extras(req, buf, is_phantom);
              <span class="hljs-keyword">if</span>( log_query ) query_logged[request_path] = path;
              respond(<span class="hljs-number">200</span>, headers, buf, res);
            });
          }
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(optimize_routed_url);</pre></div>
        
      
        
        <p>render non optimized html route</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">template_routed_url</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );</pre></div>
        
      
        
        <p>catch for html route directory</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">var</span> route = router.match(request_path);
      <span class="hljs-keyword">if</span>( route != <span class="hljs-literal">false</span> ){
        grunt.verbose.ok(<span class="hljs-string">"found routable url"</span>, request_path);

        <span class="hljs-keyword">var</span> headers = {
          <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
        };

        <span class="hljs-keyword">var</span> respond = write_handler(max_congestion,min_congestion,deliverer);</pre></div>
        
      
        
        <p>look up for response file within many directories</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">var</span> file = file_utils.find_file(user_config.web_paths, route.template);
        <span class="hljs-keyword">var</span> buf = fs.readFileSync(file).toString();
        <span class="hljs-keyword">if</span>( assets_injection_enabled ){</pre></div>
        
      
        
        <p>inject (prepend / append) assets (scripts / css) into the html tree</p>

        
          <div class='highlight'><pre>          <span class="hljs-keyword">var</span> base_url = request_path.substring(<span class="hljs-number">0</span>,request_path.lastIndexOf(<span class="hljs-string">"/"</span>)) || <span class="hljs-string">"/"</span>;
          <span class="hljs-keyword">if</span>( user_config.scripts ){
            grunt.verbose.ok(<span class="hljs-string">"injecting scripts"</span>, request_path);
            create_combined_assets(optimizer, user_config.scripts, user_config.build_run_paths);
            buf = phantomizer_helper.apply_scripts(user_config.scripts, base_url, buf);
          }
          <span class="hljs-keyword">if</span>( user_config.css ){
            grunt.verbose.ok(<span class="hljs-string">"injecting css"</span>, request_path);
            create_combined_assets(optimizer, user_config.css, user_config.build_run_paths);
            buf = phantomizer_helper.apply_styles(user_config.css, base_url, buf);
          }
        }
        buf = phantomizer_helper.inject_requirejs(requirejs_baseUrl, requirejs_src, requirejs_paths, buf, <span class="hljs-literal">null</span>);
        buf = inject_extras(req, buf, is_phantom);</pre></div>
        
      
        
        <p>if the build occurs,
add the stryke variable
to tell webclient to stop display sooner</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span>( is_in_build_process ){
          <span class="hljs-keyword">var</span> stryke = <span class="hljs-string">""</span>;
          stryke = stryke+<span class="hljs-string">"&lt;script&gt;"</span>;
          stryke = stryke+    <span class="hljs-string">"var phantomatic = true;"</span>;
          stryke = stryke+<span class="hljs-string">"&lt;/script&gt;"</span>;
          buf = buf.replace(<span class="hljs-string">"&lt;/head&gt;"</span>, stryke+<span class="hljs-string">"&lt;/head&gt;"</span>);
        }
        <span class="hljs-keyword">if</span>( log_query ) query_logged[request_path] = file;
        respond(<span class="hljs-number">200</span>, headers, buf, res);
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(template_routed_url);</pre></div>
        
      
        
        <p>render combined css/js assets</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render_combined_asset</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );

      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
      };</pre></div>
        
      
        
        <p>look up for non html files</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span>( assets_injection_enabled &amp;&amp; headers[<span class="hljs-string">"Content-Type"</span>].indexOf(<span class="hljs-string">"text/html"</span>) == -<span class="hljs-number">1</span> ){

        <span class="hljs-keyword">var</span> is_a_combined_script = optimizer.is_combined_asset(user_config.scripts, request_path);
        <span class="hljs-keyword">var</span> is_a_combined_style = optimizer.is_combined_asset(user_config.css, request_path);

        <span class="hljs-keyword">if</span>( is_a_combined_script || is_a_combined_style ){

          <span class="hljs-keyword">var</span> respond = write_handler(max_congestion,min_congestion,deliverer);

          <span class="hljs-keyword">var</span> file = file_utils.find_file([user_config.out_dir], request_path);
          <span class="hljs-keyword">var</span> is_fresh_build = optimizer.is_build_fresh(buidl_profile(req), request_path);

          <span class="hljs-keyword">if</span>( file == <span class="hljs-literal">null</span> || !is_fresh_build ){
            <span class="hljs-keyword">if</span>( is_a_combined_script ){
              create_combined_assets(optimizer, user_config.scripts, user_config.build_run_paths);
            }<span class="hljs-keyword">else</span>{
              create_combined_assets(optimizer, user_config.css, user_config.build_run_paths);
            }
          }
          file = file_utils.find_file([user_config.out_dir], request_path); <span class="hljs-comment">// we must look up again</span>
          <span class="hljs-keyword">if</span>( log_query ) query_logged[request_path] = file;
          respond(<span class="hljs-number">200</span>, headers, fs.readFileSync(file), res);
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(render_combined_asset);</pre></div>
        
      
        
        <p>render built img/css/js assets</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render_built_asset</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );

      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
      };</pre></div>
        
      
        
        <p>look up for non html files</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span>( headers[<span class="hljs-string">"Content-Type"</span>].indexOf(<span class="hljs-string">"text/html"</span>) == -<span class="hljs-number">1</span> ){</pre></div>
        
      
        
        <p>profile to use for optimization</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">var</span> tgt_build_profile = buidl_profile(req);
        <span class="hljs-keyword">var</span> is_already_build = optimizer.is_built(tgt_build_profile, request_path);

        <span class="hljs-keyword">if</span>( is_already_build ){
          <span class="hljs-keyword">var</span> file = file_utils.find_file([user_config.out_dir], request_path);
          <span class="hljs-keyword">if</span>( file ){
            <span class="hljs-keyword">var</span> respond = write_handler(max_congestion,min_congestion,deliverer);
            respond(<span class="hljs-number">200</span>, headers, fs.readFileSync(file), res);
          }<span class="hljs-keyword">else</span>{
            next();
          }
        }<span class="hljs-keyword">else</span>{
          next();
        }
      }<span class="hljs-keyword">else</span>{
        next();
      }
    }
    app.use(render_built_asset);</pre></div>
        
      
        
        <p>render any file assets text / binary</p>

        
          <div class='highlight'><pre>    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl );

      grunt.verbose.writeln(request_path);

      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: http_utils.header_content_type(request_path)
      };
      <span class="hljs-keyword">var</span> file = file_utils.find_file(user_config.web_paths,request_path);

      <span class="hljs-keyword">if</span>( file != <span class="hljs-literal">null</span> ){
        <span class="hljs-keyword">var</span> respond = write_handler(max_congestion, min_congestion, deliverer);
        <span class="hljs-keyword">var</span> buf = fs.readFileSync(file);
        respond(<span class="hljs-number">200</span>, headers, buf, res);
      }<span class="hljs-keyword">else</span>{
        next();
      }
    });</pre></div>
        
      
        
        <p>render directory listing</p>

        
          <div class='highlight'><pre>    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span>{</span>
      <span class="hljs-keyword">var</span> request_path = get_request_path( req.originalUrl )
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      <span class="hljs-keyword">if</span>( request_path != <span class="hljs-string">"/"</span> ){
        <span class="hljs-keyword">var</span> file = file_utils.find_dir(user_config.web_paths, request_path);
        <span class="hljs-keyword">if</span>( file == <span class="hljs-literal">null</span> ){
          request_path = <span class="hljs-literal">null</span>;
        }
      }

      <span class="hljs-keyword">if</span>( request_path !== <span class="hljs-literal">null</span> ){
        <span class="hljs-keyword">var</span> respond = write_handler(max_congestion,min_congestion,deliverer);
        <span class="hljs-keyword">var</span> items = http_utils.merged_dirs(user_config.web_paths, request_path);
        dirlisting.generate_directory_listing(items, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, html)</span>{</span>
          respond(<span class="hljs-number">200</span>, headers, html, res);
        });
      }<span class="hljs-keyword">else</span>{
        next();
      }
    })</pre></div>
        
      
        
        <p>render 404 response</p>

        
          <div class='highlight'><pre>    app.use(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res)</span>{</span>
      <span class="hljs-keyword">var</span> headers = {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span>
      };
      res.writeHead(<span class="hljs-number">404</span>, headers);
      res.end(<span class="hljs-string">"not found"</span>);
    })</pre></div>
        
      
        
        <h2 id="instance-methods">instance methods</h2>

        
      
        
        
        
          <div class='highlight'><pre>
    <span class="hljs-keyword">var</span> wserver = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> wsserver = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">/**
     * Starts a web server
     *  eventually also over ssl
     *
     * @param port
     * @param ssl_port
     * @param host
     */</span>
    <span class="hljs-keyword">this</span>.start = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(port, ssl_port, host)</span>{</span>
      wserver = http.createServer(app).listen(port, host);
      <span class="hljs-keyword">if</span>( ssl_port )
        wsserver = http.createServer(app).listen(ssl_port, host);
    };
    <span class="hljs-comment">/**
     * Stops a web server if started
     *  eventually also ssl
     */</span>
    <span class="hljs-keyword">this</span>.stop = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">if</span>( wserver !== <span class="hljs-literal">null</span> ) wserver.close();
      <span class="hljs-keyword">if</span>( wsserver !== <span class="hljs-literal">null</span> ) wsserver.close();
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to inject is_phantom=true; variable
     *
     * @param is_phantom
     */</span>
    <span class="hljs-keyword">this</span>.is_phantom = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( is )</span>{</span>
      is_phantom = is;
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to inject is_phantomizing=true; variable
     *
     *  it tells the build process occurs
     *
     * @param is_in_build_process
     */</span>
    <span class="hljs-keyword">this</span>.is_in_build_process = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( is )</span>{</span>
      is_in_build_process = is;
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to enabled the dashboard
     *  could still be overridden by GET variable
     *
     * @param enabled
     */</span>
    <span class="hljs-keyword">this</span>.enable_dashboard = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(enabled)</span>{</span>
      dashboard_enabled = !!enabled;
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to add globals to the DOM
     *
     * @param injected_var
     */</span>
    <span class="hljs-keyword">this</span>.inject_globals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(injected_var)</span>{</span>
      globals_injected = injected_var;
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to apply the build if GET.build_profile=.+
     *
     * @param enabled
     */</span>
    <span class="hljs-keyword">this</span>.enable_build = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(enabled)</span>{</span>
      build_enabled = !!enabled;
    };

    <span class="hljs-comment">/**
     * Instructs the web server
     *  to build/refresh/inject combined assets
     *
     * @param enabled
     */</span>
    <span class="hljs-keyword">this</span>.enable_assets_inject = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(enabled)</span>{</span>
      assets_injection_enabled = !!enabled;
    };



    <span class="hljs-comment">/**
     * Instructs the web server
     *  to logs queries that was identified as real files
     *
     * @param enabled
     */</span>
    <span class="hljs-keyword">this</span>.enable_query_logs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(enabled)</span>{</span>
      log_query = !!enabled;
    };
    <span class="hljs-keyword">this</span>.clear_query_logs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      query_logged = [];
    };
    <span class="hljs-comment">/**
     * Returns an query_logged
     *  [ request ] =&gt; file_path
     * @returns {Array}
     */</span>
    <span class="hljs-keyword">this</span>.get_query_logs = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">return</span> query_logged;
    };</pre></div>
        
      
        
        <h2 id="helper-functions">helper functions</h2>

        
      
        
        
        
          <div class='highlight'><pre>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buidl_profile</span><span class="hljs-params">(req)</span>{</span>
      <span class="hljs-keyword">return</span> req.query.build_profile || <span class="hljs-string">""</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_build_required</span><span class="hljs-params">(req)</span>{</span>
      <span class="hljs-keyword">return</span> req.query.build_profile
        || <span class="hljs-literal">false</span>;
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_combined_assets</span><span class="hljs-params">(optimizer, assets_combination, source_paths)</span>{</span>
      <span class="hljs-keyword">if</span>( assets_combination.append ){
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> target_merge <span class="hljs-keyword">in</span> assets_combination.append ){
          <span class="hljs-keyword">if</span>( target_merge.length &gt; <span class="hljs-number">1</span> ){
            <span class="hljs-keyword">var</span> asset_deps = assets_combination.append[target_merge];
            optimizer.merge_files(target_merge, asset_deps, source_paths);
            grunt.verbose.ok(<span class="hljs-string">"merged "</span>+target_merge+<span class="hljs-string">""</span>)
          }
        }
      }
      <span class="hljs-keyword">if</span>( assets_combination.prepend ){
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> target_merge <span class="hljs-keyword">in</span> assets_combination.prepend ){
          <span class="hljs-keyword">if</span>( target_merge.length &gt; <span class="hljs-number">1</span> ){
            <span class="hljs-keyword">var</span> asset_deps = assets_combination.prepend[target_merge]
            optimizer.merge_files(target_merge, asset_deps, source_paths);
            grunt.verbose.ok(<span class="hljs-string">"merged "</span>+target_merge+<span class="hljs-string">""</span>)
          }
        }
      }
    }</pre></div>
        
      
        
        <p>inject extra html content within routed request</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inject_extras</span><span class="hljs-params">(req,buf, is_phantom)</span>{</span>

      buf = phantomizer_helper.inject_requirejs(requirejs_baseUrl, requirejs_src, requirejs_paths, buf, <span class="hljs-literal">null</span>);

      <span class="hljs-keyword">if</span>( is_phantom ){
        buf = phantomizer_helper.inject_phantom(buf);
      }

      <span class="hljs-keyword">var</span> inject = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span>( (req.query.device || req.query.spec_files) ){
        inject = <span class="hljs-literal">true</span>;
      }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !req.query.no_dashboard &amp;&amp; dashboard_enabled ){
        inject = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">if</span>( globals_injected ){
        buf = buf.replace(<span class="hljs-string">"&lt;/head&gt;"</span>,<span class="hljs-string">"&lt;script&gt;window.phantomizer_globals="</span>+<span class="hljs-built_in">JSON</span>.stringify(globals_injected)+<span class="hljs-string">"&lt;/script&gt;&lt;/head&gt;"</span>);
      }

      <span class="hljs-keyword">if</span>( inject &amp;&amp; req.query.no_dashboard ){
        buf = buf.replace(<span class="hljs-string">"&lt;/head&gt;"</span>,<span class="hljs-string">"&lt;script&gt;window.no_dashboard=true;&lt;/script&gt;&lt;/head&gt;"</span>);
      }

      <span class="hljs-keyword">if</span>( inject ){
        <span class="hljs-keyword">var</span> injected = <span class="hljs-string">'/js/vendors/go-phantomizer/extras-loader.js'</span>;
        buf = phantomizer_helper.inject_after_requirejs(requirejs_baseUrl,requirejs_src, requirejs_paths, buf, injected);
      }
      <span class="hljs-keyword">return</span> buf;
    };

  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write_handler</span><span class="hljs-params">(max_congestion,min_congestion,deliverer)</span>{</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(code, headers, buf, res)</span>{</span>
      res.writeHead(code, headers);

      <span class="hljs-keyword">var</span> congestion = <span class="hljs-built_in">Math</span>.floor((<span class="hljs-built_in">Math</span>.random()*max_congestion)+min_congestion);
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        deliverer.enqueue(buf, res);
      }, congestion);
    };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_request_path</span><span class="hljs-params">( request_path )</span>{</span>
    <span class="hljs-keyword">if</span>( request_path.indexOf(<span class="hljs-string">"?"</span>)&gt;-<span class="hljs-number">1</span>){
      request_path = request_path.substring(<span class="hljs-number">0</span>,request_path.indexOf(<span class="hljs-string">"?"</span>))
    }
    <span class="hljs-keyword">return</span> request_path
  }</pre></div>
        
      
        
        <p>Expose the constructor function.</p>

        
          <div class='highlight'><pre>  exports.webserver = webserver;
}(<span class="hljs-keyword">typeof</span> exports === <span class="hljs-string">'object'</span> &amp;&amp; exports || <span class="hljs-keyword">this</span>));</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
