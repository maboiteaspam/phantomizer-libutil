<!DOCTYPE html>

<html>
<head>
  <title>router.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>router.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(exports)</span> {</span>

    <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>)
    <span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>)

    <span class="hljs-keyword">var</span> router = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routes)</span>{</span></pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>
        <span class="hljs-keyword">this</span>.load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(then)</span>{</span>
            <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">(read_urls)</span>{</span>
                routes[n].urls = read_urls;
                n++;
                <span class="hljs-keyword">if</span>( n &lt; routes.length ){
                    read_routing_urls(routes[n],next);
                }<span class="hljs-keyword">else</span>{
                    then();
                }
            }
            <span class="hljs-keyword">if</span>( routes.length &gt; <span class="hljs-number">0</span> ) read_routing_urls(routes[<span class="hljs-number">0</span>],next);
            <span class="hljs-keyword">else</span> then();
        }
        <span class="hljs-keyword">this</span>.match = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url)</span>{</span>
            <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> routes ){
                <span class="hljs-keyword">var</span> route = routes[n];
                <span class="hljs-keyword">if</span>(route.urls &amp;&amp; route.urls.indexOf(url)&gt;-<span class="hljs-number">1</span>){
                    <span class="hljs-keyword">return</span> route;
                }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( route.pattern &amp;&amp; route.pattern.match(url) ){
                    <span class="hljs-keyword">return</span> route;
                }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(route.template &amp;&amp; route.template == url){
                    <span class="hljs-keyword">return</span> route;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        };
        <span class="hljs-keyword">this</span>.collect_urls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
            <span class="hljs-keyword">var</span> urls = [];
            <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> routes ){
                <span class="hljs-keyword">var</span> route = routes[n];
                <span class="hljs-keyword">if</span>(route.urls &amp;&amp; route.urls.length &gt; <span class="hljs-number">0</span>){
                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t <span class="hljs-keyword">in</span> route.urls)
                        urls.push(route.urls[t]);
                }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(route.template){
                    urls.push(route.template);
                }
            }
            <span class="hljs-keyword">return</span> urls;
        };
        <span class="hljs-keyword">this</span>.collect_meta_urls = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
            <span class="hljs-keyword">var</span> urls = [];
            <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> routes ){
                <span class="hljs-keyword">var</span> route = routes[n];
                <span class="hljs-keyword">if</span>(route.urls &amp;&amp; route.urls.length &gt; <span class="hljs-number">0</span>){
                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t <span class="hljs-keyword">in</span> route.urls)
                        urls.push({url:route.urls[t], meta:route});
                }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(route.template){
                    urls.push({url:route.template, meta:route});
                }
            }
            <span class="hljs-keyword">return</span> urls;
        };
    };

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_routing_urls</span><span class="hljs-params">(route_options,then)</span>{</span>
        <span class="hljs-keyword">var</span> urls = [];
        <span class="hljs-keyword">if</span> (route_options.urls_datasource){
            console.log(<span class="hljs-string">"Reading urls from URL "</span>+route_options.urls_datasource);
            read_url(route_options.urls_datasource, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status,content)</span>{</span>
                urls = <span class="hljs-built_in">JSON</span>.parse(content);
                <span class="hljs-keyword">if</span>( urls.data &amp;&amp; toString.call(urls.data) == <span class="hljs-string">'[object Array]'</span> ){
                    then(urls.data);
                }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( toString.call(urls) == <span class="hljs-string">'[object Array]'</span> ){
                    then(urls);
                }
            });
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">if</span> (route_options.urls_file){
                urls = fs.readFileSync(route_options.urls_file);
                console.log(<span class="hljs-string">"Reading urls from file "</span>+route_options.urls_file);
                urls = <span class="hljs-built_in">JSON</span>.parse(urls);
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( route_options.urls ){
                urls = route_options.urls;
                console.log(<span class="hljs-string">"Reading urls inlined from options"</span>);
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (route_options.url){
                urls = [route_options.url];
                console.log(<span class="hljs-string">"Reading urls inlined from options"</span>);
            }
            then(urls);
        }
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_url</span><span class="hljs-params">(url,then)</span>{</span>
        <span class="hljs-keyword">var</span> content = <span class="hljs-string">''</span>;
        http.get(url, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> {</span>
            console.log(<span class="hljs-string">"Got response: "</span> + res.statusCode);
            res.setEncoding(<span class="hljs-string">'utf8'</span>);
            res.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chunk)</span> {</span>
                <span class="hljs-keyword">if</span>( content.length == <span class="hljs-number">0</span> &amp;&amp; chunk.match(<span class="hljs-regexp">/^[a-z0-9]+\s+[{]/igm</span>) )
                    content+=chunk.substr(chunk.indexOf(<span class="hljs-string">"\n"</span>));
                <span class="hljs-keyword">else</span>
                    content+=chunk;
                console.log(<span class="hljs-string">'BODY: '</span> + chunk.length);
            });
            res.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                content = content.trim();
                <span class="hljs-keyword">if</span>( content.match(<span class="hljs-regexp">/[}]\s+[0-9]+$/</span>) )
                    content = content.substr(<span class="hljs-number">0</span>,content.length-<span class="hljs-number">1</span>)
                <span class="hljs-keyword">if</span>( then) then(<span class="hljs-literal">true</span>,content);
            });
        }).on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(<span class="hljs-string">"Got error: "</span> + e.message);
            <span class="hljs-keyword">if</span>( then) then(<span class="hljs-literal">false</span>,content);
        });
    }</pre></div>
        
      
        
        <p>Expose the constructor function.</p>

        
          <div class='highlight'><pre>    exports.router = router;
}(<span class="hljs-keyword">typeof</span> exports === <span class="hljs-string">'object'</span> &amp;&amp; exports || <span class="hljs-keyword">this</span>));</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
